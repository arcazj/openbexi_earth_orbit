<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OBJ Viewer – starlink & starlink_V2 (Three.js)</title>
    <style>
        :root {
            --bg: #0e1116;
            --panel: rgba(20, 24, 32, 0.9);
            --muted: #a2a9b5;
            --accent: #7ac4ff;
            --ok: #7affc0;
            --warn: #ffe67a;
        }
        html, body { height: 100%; }
        body {
            margin: 0;
            background: var(--bg);
            color: white;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            overflow: hidden;
        }
        #app { position: fixed; inset: 0; }

        .panel {
            position: fixed;
            top: 12px; right: 12px;
            background: var(--panel);
            border: 1px solid #232936;
            border-radius: 12px;
            padding: 12px 14px;
            min-width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
            backdrop-filter: blur(6px);
        }
        .panel h2 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.4px;
            color: var(--accent);
        }
        .panel .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 8px 0; }
        .panel label { color: var(--muted); font-size: 12px; }
        .panel input[type="range"] { width: 160px; }
        .panel .sep { height: 1px; background: #232936; margin: 10px 0; }
        .badge { display:inline-block; padding:2px 8px; border-radius: 999px; font-size: 10px; color:#081018; background: var(--ok); font-weight:700; }
        .footer { font-size: 11px; color: var(--muted); margin-top: 8px; }
        .links a { color: var(--accent); text-decoration: none; }
        .links a:hover { text-decoration: underline; }

        .hint {
            position: fixed; left: 12px; bottom: 12px; color: var(--muted);
            font-size: 12px; background: rgba(0,0,0,0.25); padding: 6px 8px; border-radius: 8px;
            border: 1px solid #232936;
        }
    </style>

    <!-- Three.js r0.176.0 via import map -->
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.176.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.176.0/examples/jsm/"
          }
        }
    </script>
</head>
<body>
<div id="app"></div>

<div class="panel" id="ui">
    <h2>OBJ Viewer <span class="badge">MEO + GEO</span></h2>

    <div class="row"><label>Show starlink V1 (LEO)</label><input id="showstarlink" type="checkbox" checked></div>
    <div class="row"><label>Show starlink_V2 (MEO)</label><input id="showstarlink_V2" type="checkbox" checked></div>
    <div class="row"><label>Wireframe (starlink_V1)</label><input id="wirestarlink" type="checkbox"></div>
    <div class="row"><label>Wireframe (starlink_V2)</label><input id="wirestarlink_V2" type="checkbox"></div>
    <div class="row"><label>Global Scale</label><input id="scale" type="range" min="0.25" max="2.0" step="0.01" value="1.0"></div>
    <div class="row"><label>Auto-Rotate</label><input id="autorotate" type="checkbox" checked></div>
    <div class="row"><label>BG Color</label><input id="bgcolor" type="color" value="#0e1116"></div>
    <div class="row"><label>Key Light</label><input id="keylight" type="range" min="0" max="3" step="0.01" value="1.2"></div>

    <div class="sep"></div>
    <div class="links">
        <div class="footer">Place files under <code>obj/</code> next to this HTML:</div>
        <ul style="margin:6px 0 0 16px; padding:0; line-height:1.3">
            <li>obj/starlink_V1.mtl</li>
            <li>obj/starlink_V1.obj</li>
            <li>obj/starlink_V2.mtl</li>
            <li>obj/starlink_V2.obj</li>
        </ul>
    </div>
</div>

<div class="hint">Mouse: drag = orbit, right-drag = pan, wheel = zoom · Double‑click model to frame · Press <b>H</b> to toggle UI</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

    // --------- Renderer / Scene / Camera ---------
    const container = document.getElementById('app');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color('#0e1116');

    const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    container.appendChild(renderer.domElement);

    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 4.5, 14);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.target.set(0, 1, 0);

    // --------- Lights ---------
    const hemi = new THREE.HemisphereLight(0x99bbff, 0x232323, 0.6);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 1.2);
    dir.position.set(-4, -8, -6);
    dir.castShadow = false;
    scene.add(dir);

    const dir2 = new THREE.DirectionalLight(0xffffff, 1.2);
    dir2.position.set(4, 8, 6);
    dir2.castShadow = false;
    scene.add(dir2);

    // --------- Ground / Helpers ---------
    const grid = new THREE.GridHelper(80, 80, 0x3a3f4a, 0x232936);
    grid.position.y = -0.001;
    scene.add(grid);

    const axes = new THREE.AxesHelper(2.5);
    axes.position.y = 0.02;
    scene.add(axes);

    // --------- Model Containers ---------
    const root = new THREE.Group();
    scene.add(root);

    const starlinkGroup = new THREE.Group();
    starlinkGroup.name = 'starlink_V1';
    starlinkGroup.position.x = -7.0; // side-by-side spacing

    const starlink_V2Group = new THREE.Group();
    starlink_V2Group.name = 'starlink_V2';
    starlink_V2Group.position.x = +7.0;

    root.add(starlinkGroup);
    root.add(starlink_V2Group);

    // --------- Loaders ---------
    const mtlLoader = new MTLLoader();
    const objLoader = new OBJLoader();

    async function loadObjWithMtl(group, mtlUrl, objUrl) {
        return new Promise((resolve, reject) => {
            mtlLoader.load(
                mtlUrl,
                (materials) => {
                    materials.preload();
                    objLoader.setMaterials(materials);
                    objLoader.load(
                        objUrl,
                        (obj) => {
                            // Normalize and tidy up
                            obj.traverse((child) => {
                                if (child.isMesh) {
                                    child.castShadow = false;
                                    child.receiveShadow = false;
                                    if (child.material) {
                                        child.material.side = THREE.FrontSide;
                                    }
                                }
                            });
                            group.add(obj);
                            resolve(obj);
                        },
                        undefined,
                        (err) => reject(err),
                    );
                },
                undefined,
                (err) => reject(err),
            );
        });
    }

    function setWireframe(rootObj, enabled) {
        rootObj.traverse((child) => {
            if (child.isMesh) {
                const m = child.material;
                if (Array.isArray(m)) {
                    m.forEach(mat => mat.wireframe = enabled);
                } else if (m) {
                    m.wireframe = enabled;
                }
            }
        });
    }

    function fitCameraToObject(cam, object, offset=1.22) {
        const box = new THREE.Box3().setFromObject(object);
        const size = box.getSize(new THREE.Vector3());
        const center = box.getCenter(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        const fov = cam.fov * (Math.PI / 180);
        let dist = (maxDim / 2) / Math.tan(fov / 2);
        dist *= offset;
        const dirVec = new THREE.Vector3().subVectors(cam.position, controls.target).normalize();
        controls.target.copy(center);
        cam.position.copy(center.clone().add(dirVec.multiplyScalar(dist)));
        cam.near = Math.max(0.01, dist / 1000);
        cam.far = dist * 1000;
        cam.updateProjectionMatrix();
        controls.update();
    }

    // Double-click to frame whichever is visible & closer to center
    renderer.domElement.addEventListener('dblclick', () => {
        const visibleGroups = [];
        if (starlinkGroup.visible) visibleGroups.push(starlinkGroup);
        if (starlink_V2Group.visible) visibleGroups.push(starlink_V2Group);
        if (!visibleGroups.length) return;
        // Pick the one closer to controls.target
        let best = visibleGroups[0];
        let bestDist = best.position.distanceTo(controls.target);
        for (const g of visibleGroups) {
            const d = g.position.distanceTo(controls.target);
            if (d < bestDist) { best = g; bestDist = d; }
        }
        fitCameraToObject(camera, best, 1.28);
    });

    // --------- UI Bindings ---------
    const ui = {
        showstarlink: document.getElementById('showstarlink'),
        showstarlink_V2: document.getElementById('showstarlink_V2'),
        wirestarlink: document.getElementById('wirestarlink'),
        wirestarlink_V2: document.getElementById('wirestarlink_V2'),
        scale: document.getElementById('scale'),
        autorotate: document.getElementById('autorotate'),
        bgcolor: document.getElementById('bgcolor'),
        keylight: document.getElementById('keylight'),
    };

    ui.showstarlink.addEventListener('change', () => starlinkGroup.visible = ui.showstarlink.checked);
    ui.showstarlink_V2.addEventListener('change', () => starlink_V2Group.visible = ui.showstarlink_V2.checked);
    ui.wirestarlink.addEventListener('change', () => setWireframe(starlinkGroup, ui.wirestarlink.checked));
    ui.wirestarlink_V2.addEventListener('change', () => setWireframe(starlink_V2Group, ui.wirestarlink_V2.checked));
    ui.scale.addEventListener('input', () => root.scale.setScalar(parseFloat(ui.scale.value)));
    ui.autorotate.addEventListener('change', () => {/* handled in render loop */});
    ui.bgcolor.addEventListener('input', () => scene.background = new THREE.Color(ui.bgcolor.value));
    ui.keylight.addEventListener('input', () => dir.intensity = parseFloat(ui.keylight.value));

    // Toggle UI with H
    document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'h') {
            const el = document.getElementById('ui');
            el.style.display = (el.style.display === 'none') ? 'block' : 'none';
        }
    });

    // --------- Load Models ---------
    (async function init() {
        try {
            const starlink = await loadObjWithMtl(starlinkGroup, 'obj/starlink_V1.mtl', 'obj/starlink_V1.obj');
            const starlink_V2 = await loadObjWithMtl(starlink_V2Group, 'obj/starlink_V2.mtl', 'obj/starlink_V2.obj');
            // Optional: initial wireframe off but compute initial framing
            setWireframe(starlinkGroup, false);
            setWireframe(starlink_V2Group, false);
            // Frame both by fitting to the entire root
            fitCameraToObject(camera, root, 1.35);
        } catch (err) {
            console.error('Failed to load models:', err);
            const warn = document.createElement('div');
            warn.style.position = 'fixed';
            warn.style.left = '12px';
            warn.style.top = '12px';
            warn.style.background = 'rgba(160,40,40,0.8)';
            warn.style.padding = '8px 10px';
            warn.style.borderRadius = '8px';
            warn.style.fontSize = '12px';
            warn.style.boxShadow = '0 10px 30px rgba(0,0,0,0.35)';
            warn.textContent = 'Error: Could not load OBJ/MTL files. Ensure they are in the obj/ folder next to this HTML.';
            document.body.appendChild(warn);
        }
    })();

    // --------- Resize ---------
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // --------- Render Loop ---------
    const clock = new THREE.Clock();
    function animate() {
        const dt = clock.getDelta();
        if (document.getElementById('autorotate').checked) {
            root.rotation.y += dt * 0.2; // gentle autorotation
        }
        controls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
    }
    animate();
</script>
</body>
</html>

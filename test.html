<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Satellite Simulation - HTML Controls</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/satellite.js@4.0.0/dist/satellite.min.js"></script>
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.176.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.176.0/examples/jsm/"
          }
        }
    </script>
    <style>
        /* Basic styles if css/style.css is not available */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #renderer {
            display: block;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
        }

        #controls input, #controls button, #controls select {
            margin: 5px;
            padding: 5px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 3px;
        }

        #controls button:hover {
            background: #555;
            cursor: pointer;
        }

        .label {
            color: #ffff00;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 4px;
            border-radius: 3px;
            pointer-events: none;
        }

        #info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="controls">
        <h3>Satellite Model Loader</h3>
        <div>
            <label for="noradInput">NORAD ID:</label>
            <input type="number" id="noradInput" placeholder="25544" value="25544">
            <button id="loadSatellite">Load Satellite Model</button>
        </div>
        <div>
            <button id="clearModel">Clear Model</button>
            <button id="resetCamera">Reset Camera</button>
        </div>
        <div>
            <label for="rotationSpeed">Rotation Speed:</label>
            <input type="range" id="rotationSpeed" min="0" max="2" step="0.1" value="0.5">
        </div>
    </div>

    <div id="info">
        <div id="modelInfo">No model loaded</div>
    </div>
</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

    // Global variables that satelliteModelLoader expects
    window.THREE = THREE;
    window.CSS2DObject = CSS2DObject;

    // Load satelliteModelLoader after THREE.js is available
    const script1 = document.createElement('script');
    script1.src = 'js/satelliteModelLoader.js';
    script1.onload = () => {
        console.log('Local satelliteModelLoader.js loaded');
    };
    script1.onerror = () => {
        console.warn('Failed to load local satelliteModelLoader.js, trying remote...');
        const script2 = document.createElement('script');
        script2.src = 'https://raw.githubusercontent.com/arcazj/openbexi_earth_orbit/master/js/satelliteModelLoader.js';
        script2.onload = () => {
            console.log('Remote satelliteModelLoader.js loaded');
        };
        script2.onerror = () => {
            console.error('Failed to load satelliteModelLoader.js from both sources');
        };
        document.head.appendChild(script2);
    };
    document.head.appendChild(script1);
    window.METERS_TO_SCENE_UNITS = 1.0; // 1:1 scale for this demo

    // Helper functions that satelliteModelLoader expects
    window.getFullGitHubUrl = function(path) {
        // For demo purposes, return the path as-is
        // In real implementation, this would resolve GitHub URLs
        return path;
    };

    window.fetchJSON = async function(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error('fetchJSON error:', error);
            // Return mock data for demo if fetch fails
            return createMockSatelliteData();
        }
    };

    // Scene setup
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000011);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(10, 10, 10);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.getElementById('container').appendChild(renderer.domElement);

    // Make renderer globally available for satelliteModelLoader
    window.renderer = renderer;

    // CSS2D Renderer for labels
    const labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position = 'absolute';
    labelRenderer.domElement.style.top = '0px';
    labelRenderer.domElement.style.pointerEvents = 'none';
    document.getElementById('container').appendChild(labelRenderer.domElement);

    // Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    // Lighting
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 5, 5);
    directionalLight.castShadow = true;
    scene.add(directionalLight);

    // Reference grid
    const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
    scene.add(gridHelper);

    // Animation variables
    let animationId;
    let rotationSpeed = 0.5;

    // Mock satellite data for demo purposes
    function createMockSatelliteData() {
        const noradId = document.getElementById('noradInput').value || '25544';
        return {
            [noradId]: {
                name: `Satellite ${noradId}`,
                geometry: {
                    bus: {
                        width_m: 2.0,
                        height_m: 1.5,
                        depth_m: 1.0
                    },
                    solar_panels: [
                        {
                            length_m: 4.0,
                            width_m: 2.0,
                            position_m: [-3.0, 0, 0],
                            orientation: "west"
                        },
                        {
                            length_m: 4.0,
                            width_m: 2.0,
                            position_m: [3.0, 0, 0],
                            orientation: "east"
                        }
                    ],
                    antennas: [
                        {
                            type: "dish",
                            radius_m: 0.5,
                            depth_m: 0.3,
                            position_m: [0, 1.5, 0],
                            orientation: "north",
                            band: "Ka"
                        },
                        {
                            type: "sphere",
                            radius_m: 0.2,
                            position_m: [0, -1.0, 0.5],
                            band: "TT&C"
                        }
                    ],
                    thrusters: [
                        {
                            type: "cylinder",
                            radius_m: 0.1,
                            height_m: 0.3,
                            position_m: [-1.0, 0, -0.7],
                            orientation: "south"
                        },
                        {
                            type: "cone",
                            radius_bottom_m: 0.08,
                            height_m: 0.25,
                            position_m: [1.0, 0, -0.7],
                            orientation: "south"
                        }
                    ]
                }
            }
        };
    }

    // Event handlers
    document.getElementById('loadSatellite').addEventListener('click', async () => {
        const noradId = document.getElementById('noradInput').value;
        if (!noradId) {
            alert('Please enter a NORAD ID');
            return;
        }

        // Wait for satelliteModelLoader to be available
        if (typeof window.satelliteModelLoader === 'undefined') {
            console.warn('satelliteModelLoader not yet available, retrying...');
            setTimeout(() => document.getElementById('loadSatellite').click(), 500);
            return;
        }

        const model = await window.satelliteModelLoader.showSatellite(noradId, scene);
        if (model) {
            document.getElementById('modelInfo').innerHTML = `
                    <strong>Model Loaded:</strong><br>
                    NORAD ID: ${noradId}<br>
                    Components: ${Object.keys(model.userData.sourceData.geometry).join(', ')}
                `;
            // Center camera on the model
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            camera.position.copy(center);
            camera.position.y += maxDim * 2;
            camera.position.z += maxDim * 2;
            controls.target.copy(center);
            controls.update();
        } else {
            document.getElementById('modelInfo').textContent = `Failed to load model for NORAD ID: ${noradId}`;
        }
    });

    document.getElementById('clearModel').addEventListener('click', () => {
        if (window.satelliteModelLoader) {
            window.satelliteModelLoader.clearCurrentDetailedSat(scene);
            document.getElementById('modelInfo').textContent = 'No model loaded';
        }
    });

    document.getElementById('resetCamera').addEventListener('click', () => {
        camera.position.set(10, 10, 10);
        controls.target.set(0, 0, 0);
        controls.update();
    });

    document.getElementById('rotationSpeed').addEventListener('input', (e) => {
        rotationSpeed = parseFloat(e.target.value);
    });

    // Animation loop
    function animate() {
        animationId = requestAnimationFrame(animate);

        // Rotate the current satellite model if it exists
        if (window.satelliteModelLoader && window.satelliteModelLoader.currentSatModel) {
            window.satelliteModelLoader.currentSatModel.rotation.y += rotationSpeed * 0.01;
        }

        controls.update();
        renderer.render(scene, camera);
        labelRenderer.render(scene, camera);
    }

    // Handle window resize
    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        labelRenderer.setSize(window.innerWidth, window.innerHeight);
    }

    window.addEventListener('resize', onWindowResize);

    // Start animation
    animate();

    // Load a default satellite model after a short delay to ensure satelliteModelLoader is ready
    function tryLoadDefault() {
        if (window.satelliteModelLoader) {
            document.getElementById('loadSatellite').click();
        } else {
            console.log('Waiting for satelliteModelLoader...');
            setTimeout(tryLoadDefault, 500);
        }
    }
    setTimeout(tryLoadDefault, 1000);
</script>
</body>
</html>